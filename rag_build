import os
import chromadb
from chromadb.config import Settings, DEFAULT_TENANT, DEFAULT_DATABASE
from chromadb.utils import embedding_functions
from openai import OpenAI
import tiktoken
import unicodedata
from rag_load import load_nba_dataset

api_key = os.getenv("OPENAI_API_KEY")
client = OpenAI(api_key=api_key)

### ---- Text Normalization ---- ###
def normalize_text(text):
    """
    Normalize text to NFC and replace problematic characters (like non-breaking hyphen)
    """
    text = unicodedata.normalize("NFC", text)
    text = text.replace("\u2011", "-")  # replace non-breaking hyphen with normal hyphen
    return text

### ---- Chunking function ---- ###
def chunk_text(text, chunk_size=300, overlap=50):
    encoding = tiktoken.get_encoding("cl100k_base")
    tokens = encoding.encode(text)
    chunks = []
    start = 0
    while start < len(tokens):
        end = start + chunk_size
        chunks.append(encoding.decode(tokens[start:end]))
        start += chunk_size - overlap
    return chunks

### ---- Build Vector Store ---- ###
def build_chroma(persist_dir="./chroma_db"):
    docs = load_nba_dataset("nba_players.csv")[:]

    # PersistentClient for disk-based ChromaDB
    chroma_client = chromadb.PersistentClient(
        path=persist_dir,
        settings=Settings(),
        tenant=DEFAULT_TENANT,
        database=DEFAULT_DATABASE
    )

    collection = chroma_client.get_or_create_collection(
        name="nba_rag",
        metadata={"hnsw:space": "cosine"}
    )

    ef = embedding_functions.OpenAIEmbeddingFunction(
        api_key=api_key,
        model_name="text-embedding-3-small"
    )

    ids = []
    texts = []
    embeddings = []

    for doc in docs:
        chunks = chunk_text(doc["text"])
        for i, c in enumerate(chunks):
            c = normalize_text(c)  # normalize before embedding
            ids.append(f"{doc['id']}-{i}")
            texts.append(c)
            emb = ef([c])[0]
            embeddings.append(emb)

    collection.add(
        ids=ids,
        embeddings=embeddings,
        documents=texts
    )

    print("ChromaDB built and saved to", persist_dir, "with", len(ids), "chunks.")


if __name__ == "__main__":
    build_chroma()

